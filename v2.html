<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JK's DeepSeek Viewer - æ·±åº¦æ±‚ç´¢ä¼šè¯æŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            height: 100vh;
            max-width: 100%;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 10px 20px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
        }
        
        .sidebar-header h1 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-section {
            background: #f0f7ff;
            border-radius: 8px;
            border: 2px dashed #10a37f;
        }
        
        .upload-box {
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .upload-box:hover {
            background-color: #e6f7f2;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #10a37f;
        }
        
        .upload-text {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }
        
        #fileInput {
            display: none;
        }
        
        .current-file {
            padding: 10px;
            background: #e8f5e9;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .file-name {
            font-weight: 600;
            color: #2e7d32;
            word-break: break-all;
        }
        
        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-box input:focus {
            border-color: #10a37f;
        }
        
        /* æ–°å¢æœç´¢é€‰é¡¹æ ·å¼ */
        .search-options {
            margin-top: 10px;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .search-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .search-options input[type="radio"] {
            cursor: pointer;
            accent-color: #10a37f;
        }
        
        .conversation-info {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            font-size: 14px;
            color: #6c757d;
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        
        .conversation-item.active {
            background-color: #e3f2fd;
            border-left: 3px solid #10a37f;
        }
        
        .conversation-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .conversation-date {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .conversation-preview {
            color: #6c757d;
            font-size: 13px;
            margin-top: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .content-header h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .content-meta {
            color: #6c757d;
            font-size: 14px;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            background: white;
        }
        
        .message {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            border: 1px solid #e1e5e9;
        }
        
        .message-think {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        
        .message-response {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
        }
        
        .message-request {
            background: #e8f5e8;
            border-left: 4px solid #2e7d32;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .message-type {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 11px;
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .message-files {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid #e1e5e9;
        }
        
        .file-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .file-content {
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .main-content {
                height: 60vh;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10a37f;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .code-block {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.45;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>JK's DeepSeek Viewer - æ·±åº¦æ±‚ç´¢ä¼šè¯æŸ¥çœ‹å™¨</h1>
                
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <input type="file" id="fileInput" accept=".json">
                    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ DeepSeekä¼šè¯å¯¼å‡ºæ–‡ä»¶ï¼ˆJSONï¼‰</div>
                    </div>
                    <div id="currentFile" class="current-file" style="display: none;">
                        <div>å½“å‰æ–‡ä»¶ï¼š<span class="file-name" id="fileName"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢å¯¹è¯æ ‡é¢˜ã€å†…å®¹æˆ–æ—¶é—´...">
                <!-- æ–°å¢æœç´¢èŒƒå›´é€‰é¡¹ -->
                <div class="search-options">
                    <label>
                        <input type="radio" name="searchMode" value="title" checked> æ ‡é¢˜/é¢„è§ˆ
                    </label>
                    <label>
                        <input type="radio" name="searchMode" value="full"> å…¨æ–‡æœç´¢
                    </label>
                </div>
            </div>
            
            <div class="conversation-info" id="conversationInfo">
                è¯·ä¸Šä¼ JSONæ–‡ä»¶å¼€å§‹æŸ¥çœ‹
            </div>
            
            <div class="conversation-list" id="conversationList">
                <div class="empty-state">
                    <h3>æš‚æ— å¯¹è¯</h3>
                    <p>ä¸Šä¼ JSONæ–‡ä»¶åï¼Œå¯¹è¯åˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="content-header" id="contentHeader">
                <div class="empty-state">
                    <h3>é€‰æ‹©å¯¹è¯</h3>
                    <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå¯¹è¯æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <h3>æš‚æ— å†…å®¹</h3>
                    <p>é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹æµè§ˆ</p>
                </div>
            </div>
            
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let conversationsData = [];
        let currentConversationId = null;
        let currentFileName = '';
        let conversationMap = new Map(); // IDåˆ°å¯¹è¯å¯¹è±¡çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
        
        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const fileNameElement = document.getElementById('fileName');
        const currentFileElement = document.getElementById('currentFile');
        const conversationInfo = document.getElementById('conversationInfo');
        const searchInput = document.getElementById('searchInput');
        const conversationList = document.getElementById('conversationList');
        const contentHeader = document.getElementById('contentHeader');
        const messagesContainer = document.getElementById('messagesContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // é˜²æŠ–å®šæ—¶å™¨
        let searchTimeout = null;
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        fileInput.addEventListener('change', handleFileUpload);
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentFileName = file.name;
            fileNameElement.textContent = currentFileName;
            currentFileElement.style.display = 'block';
            
            loadingIndicator.classList.add('active');
            conversationList.innerHTML = '';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    processJSONData(jsonData);
                } catch (error) {
                    console.error('JSONè§£æé”™è¯¯:', error);
                    showError('JSONæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æœ‰æ•ˆçš„DeepSeekå¯¹è¯å¯¼å‡ºæ–‡ä»¶');
                } finally {
                    loadingIndicator.classList.remove('active');
                }
            };
            
            reader.onerror = function() {
                showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                loadingIndicator.classList.remove('active');
            };
            
            reader.readAsText(file);
        }
        
        // å¤„ç†JSONæ•°æ®
        function processJSONData(data) {
            try {
                if (!Array.isArray(data)) {
                    if (data.conversations && Array.isArray(data.conversations)) {
                        data = data.conversations;
                    } else if (data.data && Array.isArray(data.data)) {
                        data = data.data;
                    } else {
                        throw new Error('JSONæ ¼å¼ä¸æ”¯æŒï¼Œè¯·ç¡®ä¿æ˜¯DeepSeekå¯¹è¯å¯¼å‡ºæ–‡ä»¶');
                    }
                }
                
                // æŒ‰æ—¶é—´æ’åºï¼Œå¹¶ä¸ºæ¯ä¸ªå¯¹è¯ç”Ÿæˆå”¯ä¸€ID
                conversationsData = data.sort((a, b) => {
                    const timeA = a.inserted_at || a.created_at || '';
                    const timeB = b.inserted_at || b.created_at || '';
                    return new Date(timeB) - new Date(timeA);
                }).map((conv, index) => {
                    // ç¡®ä¿æ¯ä¸ªå¯¹è¯éƒ½æœ‰å”¯ä¸€ID
                    if (!conv.id && !conv.conversation_id) {
                        conv.id = `conv_${index}`;
                    } else {
                        conv.id = conv.id || conv.conversation_id;
                    }
                    return conv;
                });
                
                // é¢„è®¡ç®—å…¨æ–‡æœç´¢æ–‡æœ¬ï¼ˆå°å†™ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼‰
                conversationsData.forEach(conv => {
                    conv._fullText = buildFullText(conv).toLowerCase();
                });
                
                // å»ºç«‹IDåˆ°å¯¹è¯çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
                conversationMap = new Map(conversationsData.map(conv => [conv.id, conv]));
                
                conversationInfo.innerHTML = `å…± ${conversationsData.length} ä¸ªå¯¹è¯`;
                
                if (conversationsData.length > 0) {
                    renderConversationList();
                    // åº”ç”¨å½“å‰æœç´¢æ¡ä»¶
                    filterConversations();
                    // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªå¯¹è¯
                    showConversation(conversationsData[0].id);
                } else {
                    conversationList.innerHTML = '<div class="empty-state"><h3>æ²¡æœ‰æ‰¾åˆ°å¯¹è¯</h3><p>JSONæ–‡ä»¶ä¸­æ²¡æœ‰å¯¹è¯æ•°æ®</p></div>';
                }
            } catch (error) {
                console.error('æ•°æ®å¤„ç†é”™è¯¯:', error);
                showError(`æ•°æ®å¤„ç†é”™è¯¯: ${error.message}`);
            }
        }
        
        // æ„å»ºå…¨æ–‡æœç´¢æ–‡æœ¬ï¼ˆæå–æ‰€æœ‰æ¶ˆæ¯å†…å®¹ã€æ–‡ä»¶åã€æ–‡ä»¶å†…å®¹ç­‰ï¼‰
        function buildFullText(conv) {
            const texts = [];
            
            // æ·»åŠ æ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (conv.title) texts.push(conv.title);
            
            if (conv.mapping) {
                const nodes = extractMessagesFromMapping(conv.mapping);
                nodes.forEach(node => {
                    if (node.message) addMessageText(node.message, texts);
                });
            } else if (conv.messages) {
                conv.messages.forEach(msg => addMessageText(msg, texts));
            } else if (conv.content) {
                texts.push(conv.content);
            }
            
            return texts.join(' ');
        }
        
        // ä»æ¶ˆæ¯å¯¹è±¡ä¸­æå–æ–‡æœ¬
        function addMessageText(msg, texts) {
            if (msg.content) texts.push(msg.content);
            if (msg.fragments) {
                msg.fragments.forEach(f => {
                    if (f.content) texts.push(f.content);
                });
            }
            if (msg.text) texts.push(msg.text);
            if (msg.files) {
                msg.files.forEach(f => {
                    if (f.file_name) texts.push(f.file_name);
                    if (f.content) texts.push(f.content);
                });
            }
            // å¯èƒ½è¿˜æœ‰å…¶å®ƒå­—æ®µï¼Œæ ¹æ®éœ€è¦æ·»åŠ 
        }
        
        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderConversationList() {
            let listHTML = '';
            
            conversationsData.forEach((conv, index) => {
                const title = conv.title || conv.name || `å¯¹è¯ ${index + 1}`;
                const insertedAt = conv.inserted_at || conv.created_at || conv.timestamp || '';
                const preview = extractPreview(conv);
                
                listHTML += `
                    <div class="conversation-item" 
                         data-id="${conv.id}" 
                         data-title="${escapeHTML(title)}"
                         data-preview="${escapeHTML(preview)}"
                         data-datetime="${escapeHTML(insertedAt)}"
                         onclick="showConversation('${conv.id}')">
                        <div class="conversation-title">${escapeHTML(title)}</div>
                        <div class="conversation-date">${formatDateTime(insertedAt)}</div>
                        <div class="conversation-preview">${escapeHTML(preview)}</div>
                    </div>
                `;
            });
            
            conversationList.innerHTML = listHTML;
        }
        
        // æå–é¢„è§ˆï¼ˆä¿æŒä¸å˜ï¼‰
        function extractPreview(conversation) {
            if (conversation.preview || conversation.last_message) {
                return conversation.preview || conversation.last_message;
            }
            
            if (conversation.mapping) {
                for (const key in conversation.mapping) {
                    const node = conversation.mapping[key];
                    if (node && node.message && node.message.content) {
                        const content = node.message.content;
                        return content.substring(0, 100) + (content.length > 100 ? '...' : '');
                    }
                }
            }
            
            if (conversation.messages && conversation.messages.length > 0) {
                const lastMsg = conversation.messages[conversation.messages.length - 1];
                if (lastMsg.content) {
                    const content = lastMsg.content;
                    return content.substring(0, 100) + (content.length > 100 ? '...' : '');
                }
            }
            
            return 'æ— å†…å®¹é¢„è§ˆ';
        }
        
        // ä»mappingä¸­æå–æ‰€æœ‰æ¶ˆæ¯èŠ‚ç‚¹ï¼ˆå¤ç”¨åŸæœ‰å‡½æ•°ï¼‰
        function extractMessagesFromMapping(mapping) {
            const messages = [];
            
            function traverse(nodeId) {
                const node = mapping[nodeId];
                if (!node) return;
                
                if (node.message) {
                    messages.push(node);
                }
                
                if (node.children) {
                    node.children.forEach(childId => {
                        traverse(childId);
                    });
                }
            }
            
            const rootKey = Object.keys(mapping).find(key => key === 'root' || mapping[key].parent === null);
            if (rootKey) {
                traverse(rootKey);
            } else {
                Object.keys(mapping).forEach(key => {
                    const node = mapping[key];
                    if (node && node.message) {
                        messages.push(node);
                    }
                });
            }
            
            return messages;
        }
        
        // æœç´¢è¾“å…¥äº‹ä»¶ï¼ˆå¸¦é˜²æŠ–ï¼‰
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterConversations();
            }, 300);
        });
        
        // æœç´¢æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        document.querySelectorAll('input[name="searchMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                filterConversations();
            });
        });
        
        // è¿‡æ»¤å¯¹è¯åˆ—è¡¨
        function filterConversations() {
            // å¦‚æœæ²¡æœ‰å¯¹è¯æ•°æ®ï¼Œç›´æ¥è¿”å›ï¼ˆä¿æŒåŸæœ‰æç¤ºï¼‰
            if (conversationsData.length === 0) return;

            const searchTerm = searchInput.value.trim().toLowerCase();
            const mode = document.querySelector('input[name="searchMode"]:checked').value;
            const items = conversationList.getElementsByClassName('conversation-item');
            
            let visibleCount = 0;

            for (let item of items) {
                const title = item.getAttribute('data-title').toLowerCase();
                const preview = item.getAttribute('data-preview').toLowerCase();
                const dateTime = item.getAttribute('data-datetime').toLowerCase();

                let matches = false;

                if (mode === 'title') {
                    // ä»…æœç´¢æ ‡é¢˜ã€é¢„è§ˆã€æ—¶é—´
                    matches = !searchTerm || title.includes(searchTerm) || preview.includes(searchTerm) || dateTime.includes(searchTerm);
                } else {
                    // å…¨æ–‡æœç´¢ï¼šæ ‡é¢˜ã€é¢„è§ˆã€æ—¶é—´ + å…¨æ–‡å†…å®¹
                    const convId = item.getAttribute('data-id');
                    const conversation = conversationMap.get(convId);
                    const fullText = conversation ? conversation._fullText : '';
                    matches = !searchTerm || title.includes(searchTerm) || preview.includes(searchTerm) || dateTime.includes(searchTerm) || (fullText && fullText.includes(searchTerm));
                }

                item.style.display = matches ? 'block' : 'none';
                if (matches) visibleCount++;
            }

            // æ›´æ–°å¯¹è¯ä¿¡æ¯ï¼šæ˜¾ç¤ºæ€»æ•°å’Œæœç´¢ç»“æœæ•°
            const total = conversationsData.length;
            conversationInfo.innerHTML = `å…± ${total} ä¸ªå¯¹è¯ï¼Œæœç´¢ç»“æœ ${visibleCount} ä¸ª`;
        }
        
        // æ˜¾ç¤ºå¯¹è¯è¯¦æƒ…
        function showConversation(conversationId) {
            if (currentConversationId === conversationId) return;
            
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            const selectedItem = document.querySelector(`[data-id="${conversationId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            currentConversationId = conversationId;
            loadingIndicator.classList.add('active');
            
            const conversation = conversationMap.get(conversationId);
            
            if (conversation) {
                setTimeout(() => {
                    renderConversation(conversation);
                    loadingIndicator.classList.remove('active');
                }, 100);
            } else {
                showError('æ‰¾ä¸åˆ°æŒ‡å®šçš„å¯¹è¯');
                loadingIndicator.classList.remove('active');
            }
        }
        
        // æ¸²æŸ“å¯¹è¯è¯¦æƒ…ï¼ˆä¿æŒä¸å˜ï¼Œä½†éœ€è¦ç¡®ä¿ä½¿ç”¨conv.idï¼‰
        function renderConversation(conversation) {
            const insertedAt = formatDateTimeFull(conversation.inserted_at || conversation.created_at);
            const updatedAt = formatDateTimeFull(conversation.updated_at || conversation.modified_at || conversation.inserted_at);
            const title = conversation.title || conversation.name || 'æ— æ ‡é¢˜å¯¹è¯';
            const convId = conversation.id || 'æœªçŸ¥';
            
            contentHeader.innerHTML = `
                <h2>${escapeHTML(title)}</h2>
                <div class="content-meta">
                    <div>åˆ›å»ºæ—¶é—´: ${insertedAt}</div>
                    <div>æ›´æ–°æ—¶é—´: ${updatedAt}</div>
                    <div>ID: ${convId}</div>
                </div>
            `;
            
            messagesContainer.innerHTML = '';
            
            if (conversation.mapping) {
                renderMappingMessages(conversation.mapping);
            } else if (conversation.messages) {
                renderSimpleMessages(conversation.messages);
            } else if (conversation.content) {
                renderContent(conversation);
            } else {
                messagesContainer.innerHTML = '<div class="empty-state"><h3>æ— æ¶ˆæ¯å†…å®¹</h3><p>æ­¤å¯¹è¯æ²¡æœ‰å¯æ˜¾ç¤ºçš„æ¶ˆæ¯</p></div>';
            }
            
            messagesContainer.scrollTop = 0;
        }
        
        function renderMappingMessages(mapping) {
            const messages = extractMessagesFromMapping(mapping);
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div class="empty-state"><h3>æ— æ¶ˆæ¯å†…å®¹</h3><p>mappingç»“æ„ä¸­æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯</p></div>';
                return;
            }
            
            messages.forEach(messageNode => {
                if (messageNode.message) {
                    const messageElement = createMessageElement(messageNode.message);
                    messagesContainer.appendChild(messageElement);
                }
            });
        }
        
        function renderSimpleMessages(messages) {
            messages.forEach(message => {
                const messageElement = createMessageElement(message);
                messagesContainer.appendChild(messageElement);
            });
        }
        
        function renderContent(conversation) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-response';
            
            let content = conversation.content;
            if (typeof content !== 'string') {
                content = JSON.stringify(content, null, 2);
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-type">CONTENT</span>
                    <span class="message-time">${formatDateTimeFull(conversation.inserted_at || conversation.created_at)}</span>
                </div>
                <div class="message-content">${escapeHTML(content)}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼ˆä¿æŒä¸å˜ï¼‰
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            
            let messageType = 'unknown';
            let messageClass = 'message';
            
            if (message.role) {
                messageType = message.role;
                messageClass = `message message-${messageType}`;
            } else if (message.fragments && message.fragments.length > 0) {
                const fragment = message.fragments[0];
                messageType = fragment.type || 'unknown';
                messageClass = `message message-${messageType.toLowerCase()}`;
            } else if (message.model) {
                messageType = 'assistant';
                messageClass = 'message message-response';
            } else if (message.author && message.author.role) {
                messageType = message.author.role;
                messageClass = `message message-${messageType}`;
            }
            
            const messageTime = message.inserted_at || message.created_at || message.timestamp || '';
            
            let messageContent = '';
            
            if (message.content) {
                messageContent = message.content;
            } else if (message.fragments) {
                message.fragments.forEach(fragment => {
                    if (fragment.content) {
                        messageContent += fragment.content + '\n\n';
                    }
                });
            } else if (message.text) {
                messageContent = message.text;
            }
            
            let filesInfo = '';
            if (message.files && message.files.length > 0) {
                filesInfo = '<div class="message-files"><strong>æ–‡ä»¶:</strong><br>';
                message.files.forEach(file => {
                    filesInfo += `<div class="file-item">`;
                    filesInfo += `<div class="file-name">â€¢ ${file.file_name || file.name || 'æœªå‘½åæ–‡ä»¶'} (ID: ${file.id || 'æ— ID'})</div>`;
                    if (file.content) {
                        filesInfo += `<div class="file-content">${escapeHTML(file.content)}</div>`;
                    }
                    filesInfo += `</div>`;
                });
                filesInfo += '</div>';
            }
            
            let metadata = '';
            if (message.metadata) {
                metadata = `<div class="message-files"><strong>å…ƒæ•°æ®:</strong><br><pre>${JSON.stringify(message.metadata, null, 2)}</pre></div>`;
            }
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-type">${messageType.toUpperCase()}</span>
                    <span class="message-time">${formatDateTimeFull(messageTime)}</span>
                </div>
                <div class="message-content">${escapeHTML(messageContent.trim())}</div>
                ${filesInfo}
                ${metadata}
            `;
            
            return messageDiv;
        }
        
        // å·¥å…·å‡½æ•°
        function formatDateTime(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function formatDateTimeFull(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function escapeHTML(text) {
            if (!text) return "";
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML
                .replace(/\n/g, '<br>')
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
                .replace(/  /g, '&nbsp;&nbsp;');
        }
        
        function showError(message) {
            conversationList.innerHTML = `<div class="error-message">${message}</div>`;
            contentHeader.innerHTML = '<div class="empty-state"><h3>é”™è¯¯</h3><p>è¯·ä¸Šä¼ æœ‰æ•ˆçš„JSONæ–‡ä»¶</p></div>';
            messagesContainer.innerHTML = '<div class="empty-state"><h3>é”™è¯¯</h3><p>æ— æ³•åŠ è½½å¯¹è¯å†…å®¹</p></div>';
        }
        
        // æ‹–æ”¾ä¸Šä¼ æ”¯æŒ
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBox = document.querySelector('.upload-box');
            
            uploadBox.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadBox.style.backgroundColor = '#e6f7f2';
            });
            
            uploadBox.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadBox.style.backgroundColor = '';
            });
            
            uploadBox.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadBox.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.json')) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    } else {
                        showError('è¯·ä¸Šä¼ JSONæ ¼å¼çš„æ–‡ä»¶');
                    }
                }
            });
        });
    </script>
</body>
</html>